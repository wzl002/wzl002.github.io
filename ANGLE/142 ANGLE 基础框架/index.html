<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>1. Angle 背景介绍 - Wesley的轨迹</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Wesley的轨迹</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../index.md" class="nav-link">首页</a>
                            </li>
                            <li class="navitem">
                                <a href="../../GLES/Framebuffer%20Object/" class="nav-link">OpenGL(ES)</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Vulkan <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../Vulkan/0.1.%20Vulkan%20%E6%89%A9%E5%B1%95/" class="dropdown-item">0.1. Vulkan 扩展</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#1-angle" class="nav-link">1. Angle 背景介绍</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#angle-almost-native-graphics-layer-engine" class="nav-link">ANGLE (Almost Native Graphics Layer Engine)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">支持的转换</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_3" class="nav-link">发展时间线</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_4" class="nav-link">应用</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#2" class="nav-link">2. 开发与调试</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_5" class="nav-link">源码构建</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#angle-gles" class="nav-link">使用 ANGLE 开发 GLES 应用</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#deqp" class="nav-link">dEQP 测试</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#3" class="nav-link">3. 源码结构</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_7" class="nav-link">源码目录结构</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_8" class="nav-link">类关系:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#4-drawelements" class="nav-link">4. 流程示例 DrawElements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#3_1" class="nav-link">3. 配置</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_9" class="nav-link">参数</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#_10" class="nav-link">总结</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#_11" class="nav-link">其他参考资料</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="1-angle">1. Angle 背景介绍</h1>
<h2 id="angle-almost-native-graphics-layer-engine"><strong>ANGLE</strong> (<em>Almost Native Graphics Layer Engine</em>)</h2>
<p>AGNLE 是 Google 开发的, 开源的图形引擎 (<a href="https://en.wikipedia.org/wiki/BSD">BSD</a> license).  Github地址: https://github.com/google/angle.  </p>
<ul>
<li>作用: </li>
<li>
<p>将 OpenGL ES API 调用翻译到各平台硬件支撑的 API (DirectX / Vulkan / OpenGL), 来实现无缝的跨平台的 OpenGL ES 应用, </p>
</li>
<li>
<p>目的: </p>
</li>
<li>为 Chromium 等各浏览器提供 跨硬件/驱动/平台的 WebGL 支持.<ul>
<li>最初目标: 在 WebGL的子集 OpenGL ES 2.0 和 DirectX 9.0c 之间建立简单的层，用来支持 Chrome 在任意 Windows 系统中都可以处理 3D 图形.</li>
<li>项目归于Chrome项目下: <a href="https://chromium.googlesource.com/angle/angle">chromium / angle</a> </li>
<li>Android 10 中实验性加入 ANGLE, 目标在未来实现 OpenGL ES on Vulkan</li>
<li><strong>供应商 专注于实现具有 GL 仿真功能的高质量 Vulkan 驱动。</strong>(2019年7月, Vulkan Session)</li>
</ul>
</li>
</ul>
<pre><code class="language-plantuml">@startuml
package Browsers &lt;&lt;Rectangle&gt;&gt; {
  package WebGL &lt;&lt;Rectangle&gt;&gt; { 

  }
}
package &quot;OpenGL ES&quot; &lt;&lt;Rectangle&gt;&gt; {

}
package ANGLE &lt;&lt;Rectangle&gt;&gt; {

}
package Direct3D &lt;&lt;Rectangle&gt;&gt; {

}
package Vulkan &lt;&lt;Rectangle&gt;&gt; {

}
package OpenGL &lt;&lt;Rectangle&gt;&gt; {

}

WebGL --&gt; &quot;OpenGL ES&quot; 
 &quot;OpenGL ES&quot; --&gt; ANGLE
 ANGLE --&gt; Direct3D
 ANGLE --&gt; Vulkan
 ANGLE --&gt; OpenGL
@enduml
</code></pre>
<h2 id="_1">支持的转换</h2>
<ul>
<li>当前 ANGLE 支持的转换</li>
<li>From <ul>
<li><strong>OpenGL ES 2.0, 3.0 and 3.1</strong> </li>
</ul>
</li>
<li>To <ul>
<li><strong>Vulkan, desktop OpenGL,  OpenGL ES,  Direct3D 9, and Direct3D 11</strong>. </li>
</ul>
</li>
</ul>
<pre><code class="language-plantuml">@startmindmap
* ANGLE
** Vulkan
** Desktop OpenGL
** Direct3D 9
** Direct3D 11
left side
** OpenGL ES 2.0
**  3.0
**  3.1

@endmindmap
</code></pre>
<ul>
<li>其他功能</li>
<li>ANGLE 实现了 <strong>EGL 1.4</strong> </li>
<li>
<p>Shader Compiler 中的翻译器</p>
</li>
<li>
<p>在跨平台的 WebGL 实现中,  <strong>ANGLE</strong> <strong>shader compiler</strong> 的一部分被用作着色器验证器 (validator)  和转换器 (translator) 。 </p>
<ul>
<li>着色器验证器 (validator) 确保在浏览器和平台之间接受一致的GLSL ES着色器集。 </li>
<li>着色器转换器 (translator) 可用于<ul>
<li>将着色器翻译为其他着色语言，</li>
</ul>
</li>
<li>可以选择性的应用着色器修改来解决本机图形驱动程序中的错误或特殊处理。 <ul>
<li>该翻译程序目标包括 Desktop <strong>GLSL</strong>，Vulkan GLSL，Direct3D <strong>HLSL</strong>, 甚至是原生 GLES2 平台的 ESSL。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>未来</p>
</li>
<li>正在实现 ES 3.2, 并提供转换到  Metal 和支持 MacOS, Chrome OS, 和 Fuchsia .</li>
</ul>
<h3 id="opengl-es">支持的 OpenGL ES 版本与后台</h3>
<table>
<thead>
<tr>
<th></th>
<th>Direct3D 9</th>
<th>Direct3D 11</th>
<th>Desktop GL</th>
<th>GL ES</th>
<th>Vulkan</th>
<th>Metal</th>
</tr>
</thead>
<tbody>
<tr>
<td>OpenGL ES 2.0</td>
<td>complete</td>
<td>complete</td>
<td>complete</td>
<td>complete</td>
<td><strong>complete</strong></td>
<td>complete</td>
</tr>
<tr>
<td>OpenGL ES 3.0</td>
<td></td>
<td>complete</td>
<td>complete</td>
<td>complete</td>
<td><strong>complete</strong></td>
<td>in progress</td>
</tr>
<tr>
<td>OpenGL ES 3.1</td>
<td></td>
<td>incomplete</td>
<td>complete</td>
<td>complete</td>
<td><strong>complete</strong></td>
<td></td>
</tr>
<tr>
<td>OpenGL ES 3.2</td>
<td></td>
<td></td>
<td>in progress</td>
<td>in progress</td>
<td><strong>in progress</strong></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="_2">后台对应的平台</h3>
<table>
<thead>
<tr>
<th></th>
<th>Direct3D 9</th>
<th>Direct3D 11</th>
<th>Desktop GL</th>
<th>GL ES</th>
<th>Vulkan</th>
<th>Metal</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows</td>
<td>complete</td>
<td>complete</td>
<td>complete</td>
<td>complete</td>
<td>complete</td>
<td></td>
</tr>
<tr>
<td>Linux</td>
<td></td>
<td></td>
<td>complete</td>
<td></td>
<td>complete</td>
<td></td>
</tr>
<tr>
<td>Mac OS X</td>
<td></td>
<td></td>
<td>complete</td>
<td></td>
<td></td>
<td>in progress</td>
</tr>
<tr>
<td>iOS</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>planned</td>
</tr>
<tr>
<td>Chrome OS</td>
<td></td>
<td></td>
<td></td>
<td>complete</td>
<td>planned</td>
<td></td>
</tr>
<tr>
<td><strong>Android</strong></td>
<td></td>
<td></td>
<td></td>
<td><strong>complete</strong></td>
<td><strong>complete</strong></td>
<td></td>
</tr>
<tr>
<td>GGP (Stadia)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>complete</td>
<td></td>
</tr>
<tr>
<td>Fuchsia</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>in progress</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="_3">发展时间线</h2>
<ul>
<li>
<p>2010 年3月 宣布立项 (<a href="https://blog.chromium.org/2010/03/introducing-angle-project.html">google blog</a>)</p>
</li>
<li>
<p>主要以支持 WebGL on DirectX 为来实现 Chrome on Windows 为目的.</p>
</li>
<li>
<p>2011年11月 ANGLE v1.0.772 通过 OpenGL 2.0.3 的认证测试.</p>
</li>
</ul>
<p>...</p>
<ul>
<li>2019年3月 发布 <strong>Android Q (10)</strong> 时称, 将实验性导入 <strong>Angle on Vulkan</strong> (<a href="https://android-developers.googleblog.com/2019/03/introducing-android-q-beta.html">google blog</a>)</li>
<li>开发者选项含 "OpenGL 驱动切换" 功能, 可以切换到 Angle, 然后运行gles 的 app进行测试.</li>
<li>跑分测试只有原生OpenGL性能的约63%, 并存在黑屏或闪烁. (2019年7月 <a href="https://new.qq.com/omn/20190728/20190728A071XR00.html?pc">腾讯网:Angle性能测试</a> )</li>
<li>
<p><strong>ANGLE性能大约是原生驱动的 65%-90%, 其中在render off-screen 时在65%左右, 在render front / back buffer时可达90%.</strong> (2019年8月 Vulkan Sessions SIGGRAPH )</p>
</li>
<li>
<p>基于Vulkan后端的测试认证:</p>
</li>
<li>2019年11月: OpenGL ES 2.0: ANGLE 2.1.0.d46e2fb1e341</li>
<li>2020年2月:   OpenGL ES 3.0: ANGLE 2.1.0.f18ff947360d</li>
<li>2020年7月:  OpenGL ES 3.1: ANGLE 2.1.0.f5dace0f1e57</li>
</ul>
<h2 id="_4">应用</h2>
<ul>
<li>
<p>浏览器的 WebGL 默认后端</p>
</li>
<li>
<p>Chrome, Firefox, Safari, Edge</p>
</li>
<li>
<p>Chrome 使用ANGLE 进行 Windows上的所有图形渲染，包括加速的Canvas2D实施和Native Client沙箱环境。</p>
</li>
<li>
<p>Shader 验证器</p>
</li>
<li>Chrome, Firefox, Safari on Windows, MacOS, Linux, mobile</li>
<li>
<p>移植</p>
</li>
<li>
<p>Qt Framework</p>
</li>
<li>提供从 Android 向 Windows 移植应用</li>
<li>
<p>RetroArch (多平台模拟器) 利用ANGLE, 实现在 Xbox One版模拟器上运行 OpenGL ES</p>
</li>
<li>
<p>微软提供支持</p>
</li>
<li>2014年增加了在 Windows Store 应用程序中使用 ANGLE 的功能。<ul>
<li>在 ANGLE 的 EGL 中支持 CoreWindow 和 SwapChainPanel 可以使应用程序在 Windows 8 以上运行。</li>
<li>VS Studio 提供 Windows Phone app 开发插件ANGLE支持</li>
</ul>
</li>
<li>微软员工在此过程中也少量参与 ANGLE 的贡献 </li>
</ul>
<h1 id="2">2. 开发与调试</h1>
<h2 id="_5">源码构建</h2>
<p>在 <strong>Windows</strong> 上build, 并可以生成包含源码的, 可调试的 VS Solution.</p>
<ul>
<li>
<p>安装 Visual Studio 2019</p>
</li>
<li>
<p>安装最新 Window 10 SDK</p>
</li>
<li>
<p>安装 Chromium's <a href="http://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up">depot_tools</a></p>
</li>
<li>
<p>将 <code>depot_tools</code> 添加到 PATH </p>
</li>
<li>
<p><strong>IMPORTANT</strong>:  在系统环境变量中设置 DEPOT_TOOLS_WIN_TOOLCHAIN=0 </p>
</li>
<li>
<p>安装 Git, 获取源码</p>
</li>
<li>
<p><code>git clone https://chromium.googlesource.com/angle/angle
    cd angle
    python scripts/bootstrap.py
    gclient sync
    git checkout master</code></p>
</li>
<li>
<p>生成 ninja 文件:</p>
</li>
</ul>
<p><code>gn gen out/Debug --sln=angle-debug --ide=vs2019</code></p>
<ul>
<li>
<p>在 Visual Studio 中, 打开 ANGLE solution : <code>out/Debug/angle-debug.sln</code>.</p>
</li>
<li>
<p>此时, <code>sample projects</code> 和 <code>angle_end2end_tests</code>, <code>angle_unittests</code> 应该可以运行了. </p>
</li>
</ul>
<p>详细步骤 及其他平台, 可参见 github/angle 文档 <a href="https://github.com/google/angle/blob/master/doc/DevSetup.md">Dev setup instructions</a>. </p>
<h2 id="angle-gles">使用 ANGLE 开发 GLES 应用</h2>
<p><strong>Windows VS C++</strong>:</p>
<ol>
<li>
<p>添加  <code>angle/include</code> 文件夹来访问标准的 Khronos EGL, GLES2 header 文件.</p>
</li>
<li>
<p>参照上文 <a href="#构建引用">构建引用</a>, 使用 Visual Studio 来 build ANGLE, 并在 output 中找到构建的 .lib 文件</p>
</li>
<li>复制 <code>libEGL.lib</code> 和<code>libGLESv2.lib</code> , 并配装 Linker</li>
</ol>
<p>此时可以使用 GLES 和 EGL 开发应用了</p>
<p>Linux 和 MacOS:</p>
<ul>
<li>将应用连接到 <code>libGLESv2</code> and <code>libEGL</code></li>
<li>使用 <code>dlopen</code> 在运行时加载 OpenGL ES 和 EGL 入口.</li>
</ul>
<h2 id="deqp">dEQP 测试</h2>
<p>deqp (drawElements Quality Program) Testing </p>
<ul>
<li>
<p>drawElements 质量计划测试 是针对GLES2，GLES3 + 和 EGL 的 强大且全面的开源测试集。</p>
</li>
<li>
<p>它们为几乎所有GL API功能都提供了广泛的覆盖范围。</p>
</li>
<li>
<p>默认情况下，ANGLE 将构建 dEQP 测试目标，以针对GLES 2，GLES 3，EGL和GLES 3.1（在受支持的平台上）进行测试。</p>
</li>
<li>
<p>支持 Android 平台测试, 需安装对应 APK</p>
</li>
<li>
<p>现可以构建的包括 GLES 2.0 和 3.0, EGL 的 包含&amp;不包含 google test 套件的测试</p>
</li>
<li>
<p>对于 GLES 3.1 测试, 目前处于实验阶段</p>
</li>
</ul>
<p>构建测试方法, 参见 https://github.com/google/angle/blob/master/doc/dEQP.md</p>
<h3 id="_6">测试结果</h3>
<p>官方上传每日更新的测试结果, 并绘制成在线图表: </p>
<p>以下是 GLES on Vulkan for Android</p>
<p><img src="./img/test.PNG" alt="test.PNG" style="zoom:38%;" /></p>
<p><img src="./img/test 3.1.PNG" alt="test31.PNG" style="zoom:38%;" /></p>
<p>GLES on Vulkan for Android </p>
<ul>
<li>2.0 和 3.0 支持度超过95%</li>
<li>3.1 支持度约 65%, 可能与 dEQP 测试的不完整有关</li>
</ul>
<p>完整测试结果: https://chromium.googlesource.com/angle/angle/+/master/doc/dEQP-Charts.md</p>
<hr />
<h1 id="3">3. 源码结构</h1>
<p>本章节收集 Angle 官方已公布的代码分析资料, 分析实现逻辑.</p>
<p><img src=".\img\agnle layers.PNG" style="zoom:28%;" /></p>
<p>示意代码, 非源码:</p>
<ul>
<li>Front-End (State Tracking):  Buffer</li>
</ul>
<pre><code class="language-c++">angle::Result Buffer::bufferData(Context *context,
BufferBinding target,
const void *data,
GLsizeiptr size,
BufferUsage usage)
{
    ANGLE_TRY(mImpl-&gt;setData(context, target, data, size, usage));

    mIndexRangeCache.clear();
    mState.mUsage = usage;
    mState.mSize = size;

    onStateChange(angle::SubjectMessage::SubjectChanged);

    return angle::Result::Continue;
}

</code></pre>
<ul>
<li>VK Back-End:  BufferVk</li>
</ul>
<pre><code class="language-c++">angle::Result BufferVk::setData(const gl::Context *context,
                                gl::BufferBinding target,
                                const void *data,
                                size_t size,
                                gl::BufferUsage usage)
{
    ContextVk *contextVk = vk::GetImpl(context);
    if (size &gt; static_cast&lt;size_t&gt;(mState.getSize()))
    {
        // Release and re-create the memory and buffer.
        release(contextVk);

        VkBufferCreateInfo createInfo = { /* ... */ };
        ANGLE_TRY(mBuffer.init(contextVk, createInfo, kMemoryPropertyFlags));
    }
    if (data &amp;&amp; size &gt; 0)
    {
        ANGLE_TRY(setDataImpl(contextVk, data, size, 0));
    }

    return angle::Result::Continue;
}

</code></pre>
<h2 id="_7">源码目录结构</h2>
<p>核心代码位于 src/libANGLE/</p>
<p>ANGLE 现在已经演变为MANGLE，即 Multi-platform ANGLE. </p>
<ul>
<li>在MANGLE的语义中，D3D / GL / Vulkan 是它的一个renderer</li>
</ul>
<table>
<thead>
<tr>
<th>目录</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>android</td>
<td></td>
</tr>
<tr>
<td>build_overrides</td>
<td></td>
</tr>
<tr>
<td>doc</td>
<td>文档</td>
</tr>
<tr>
<td>extensions</td>
<td>相关插件描述,  txt 文件</td>
</tr>
<tr>
<td>gni</td>
<td></td>
</tr>
<tr>
<td>include</td>
<td>GLES, EGL 标准头文件,</td>
</tr>
<tr>
<td>infra</td>
<td></td>
</tr>
<tr>
<td>samples</td>
<td>可本地运行的测试示例, 参照自 <OpenGL(R) ES 2.0 Programming Guide></td>
</tr>
<tr>
<td>script</td>
<td>ninjia 构建脚本, for depot_tools</td>
</tr>
<tr>
<td>src</td>
<td>源码</td>
</tr>
<tr>
<td>...</td>
<td></td>
</tr>
<tr>
<td>src\compiler</td>
<td>GLSL 翻译器</td>
</tr>
<tr>
<td>...</td>
<td></td>
</tr>
<tr>
<td>src\libANGLE</td>
<td>核心源码, Entery Points, GL Validation, GL Context, State Tracking</td>
</tr>
<tr>
<td>src\libANGLE\renderer</td>
<td>核心源码 \ 后台接口及实现</td>
</tr>
<tr>
<td>src\libANGLE\renderer\d3d</td>
<td>核心源码 \ 后台接口及实现 \ DirectX 实现</td>
</tr>
<tr>
<td>src\libANGLE\renderer\metal</td>
<td>.....                                            Metal 实现</td>
</tr>
<tr>
<td><strong>src\libANGLE\renderer\vulkan</strong></td>
<td>.....                                            <strong>Vulkan 实现</strong></td>
</tr>
<tr>
<td>...</td>
<td></td>
</tr>
<tr>
<td>third_party</td>
<td></td>
</tr>
<tr>
<td>tools</td>
<td></td>
</tr>
<tr>
<td>util</td>
<td></td>
</tr>
</tbody>
</table>
<p>各目录下的部分类</p>
<table>
<thead>
<tr>
<th>libANGLE</th>
<th>libANGLE/renderer</th>
<th>Vulkan Backend (libANGLE/renderer/vulkan)</th>
</tr>
</thead>
<tbody>
<tr>
<td>AttributeMap.h<br/>BinaryStream.h<br/>BlobCache.h<br/>Buffer.h<br/>Caps.h<br/>Compiler.h<br/>Config.h<br/>Constants.h<br/>Context.h<br/>Context_gl.cpp<br/>Context_gles_1_0.cpp<br/>Context_gles_1_0_autogen.h<br/>Context_gles_2_0_autogen.h<br/>Context_gles_3_0_autogen.h<br/>Context_gles_3_1_autogen.h<br/>Context_gles_3_2_autogen.h<br/>Context_gles_ext_autogen.h<br/>Context_gl_1_autogen.h<br/>Debug.h<br/>Device.cpp<br/>Device.h<br/>Display.h<br/>EGLSync.h<br/>Error.h<br/>Fence.h<br/>Framebuffer.h<br/>FramebufferAttachment.h<br/>FrameCapture.h<br/>FrameCapture_mock.cpp<br/>GLES1Renderer.h<br/>GLES1State.h<br/>HandleAllocator.h<br/>Image.h<br/>ImageIndex.h<br/>IndexRangeCache.h<br/>InfoLog.h<br/>LoggingAnnotator.h<br/>MemoryObject.h<br/>MemoryProgramCache.h<br/>Observer.h<br/>Overlay.h<br/>OverlayWidgets.h<br/>Program.h<br/>ProgramExecutable.h<br/>ProgramLinkedResources.h<br/>ProgramPipeline.h<br/>Query.h<br/>queryconversions.h<br/>queryutils.h<br/>RefCountObject.h<br/>Renderbuffer.h<br/>ResourceManager.h<br/>ResourceMap.h<br/>Sampler.cpp<br/>Sampler.h<br/>Semaphore.h<br/>Shader.h<br/>SizedMRUCache.h<br/>State.cpp<br/>State.h<br/>Stream.h<br/>Surface.h<br/>Texture.h<br/>Thread.h<br/>trace.h<br/>TransformFeedback.h<br/>Uniform.h<br/>validation (about 30 validations)<br/>VaryingPacking.h<br/>VertexArray.cpp<br/>VertexArray.h<br/>VertexAttribute.h<br/>WorkerThread.h</td>
<td>BufferImpl.h<br/>CompilerImpl.h<br/>ContextImpl.h<br/>DeviceImpl.h<br/>DisplayImpl.h<br/>EGLImplFactory.h<br/>EGLReusableSync.h<br/>EGLSyncImpl.h<br/>FenceNVImpl.h<br/>Format.h<br/>FormatID_autogen.h<br/>FramebufferAttachmentObjectImpl.h<br/>FramebufferImpl.h<br/>GLImplFactory.h<br/>glslang_wrapper_utils.h<br/>ImageImpl.h<br/>ImageImpl_mock.h<br/>load_functions_table.h<br/>MemoryObjectImpl.h<br/>OverlayImpl.h<br/>ProgramImpl.h<br/>ProgramPipelineImpl.h<br/>QueryImpl.h<br/>RenderbufferImpl.h<br/>renderer_utils.h<br/>RenderTargetCache.h<br/>SamplerImpl.h<br/>SemaphoreImpl.h<br/>serial_utils.h<br/>ShaderImpl.h<br/>StreamProducerImpl.h<br/>SurfaceImpl.h<br/>SyncImpl.h<br/>TextureImpl.h<br/>TransformFeedbackImpl.h<br/>VertexArrayImpl.h</td>
<td>BufferVk.h<br/>CommandProcessor.h<br/>CompilerVk.h<br/>ContextVk.h<br/>DebugAnnotatorVk.h<br/>DeviceVk.h<br/>DisplayVk.h<br/>FenceNVVk.h<br/>FramebufferVk.h<br/>GlslangWrapperVk.h<br/>ImageVk.h<br/>MemoryObjectVk.h<br/>OverlayVk.h<br/>PersistentCommandPool.h<br/>ProgramExecutableVk.h<br/>ProgramPipelineVk.h<br/>ProgramVk.h<br/>QueryVk.h<br/>RenderbufferVk.h<br/>RendererVk.h<br/>RenderTargetVk.h<br/>ResourceVk.h<br/>SamplerVk.h<br/>SecondaryCommandBuffer.h<br/>SemaphoreVk.h<br/>ShaderVk.h<br/>SurfaceVk.h<br/>SyncVk.h<br/>TextureVk.h<br/>TransformFeedbackVk.h<br/>UtilsVk.h<br/>VertexArrayVk.h</td>
</tr>
</tbody>
</table>
<h2 id="_8">类关系:</h2>
<p>renderer&lt;--display</p>
<h1 id="4-drawelements">4. 流程示例 DrawElements</h1>
<p>libANGLE 中, 为各类型定义了类, 如 Context, Renderer (GLES1Renderer)</p>
<p>DrawElements 主要流程示意图:</p>
<pre><code class="language-plantuml">@startuml
Application-&gt; entry_point_2_0: glDrawElements
entry_point_2_0 -&gt; entry_point_2_0: ValidateDrawElements
entry_point_2_0 -&gt; Context: drawElements
Context-&gt; GLES1Renderer: prepareForDraw
GLES1Renderer -&gt; GLES1Renderer: checkState
GLES1Renderer -&gt; Program : setUniform1fv
GLES1Renderer -&gt; Context
Context-&gt; ContextVk: drawElements
ContextVk-&gt; SecondaryCommandBuffer: drawIndexed
SecondaryCommandBuffer --&gt; SecondaryCommandBuffer : CommandID::\nDrawIndexed
@enduml
</code></pre>
<p>entry_points_gles_2_0_autogen.cpp : </p>
<pre><code class="language-c++">void GL_APIENTRY DrawElements(GLenum mode, GLsizei count, GLenum type, const void *indices)
{
    Context *context = GetValidGlobalContext();
    EVENT(context, GLDrawElements,
          &quot;context = %d, mode = %s, count = %d, type = %s, indices = 0x%016&quot; PRIxPTR &quot;&quot;,
          CID(context), GLenumToString(GLenumGroup::PrimitiveType, mode), count,
          GLenumToString(GLenumGroup::DrawElementsType, type), (uintptr_t)indices);

    if (context)
    {
        PrimitiveMode modePacked                              = PackParam&lt;PrimitiveMode&gt;(mode);
        DrawElementsType typePacked                           = PackParam&lt;DrawElementsType&gt;(type);
        std::unique_lock&lt;angle::GlobalMutex&gt; shareContextLock = GetShareGroupLock(context);
        bool isCallValid                                      = (context-&gt;skipValidation() ||
                            ValidateDrawElements(context, modePacked, count, typePacked, indices));
        if (isCallValid)
        {
            context-&gt;drawElements(modePacked, count, typePacked, indices);
        }
        ANGLE_CAPTURE(DrawElements, isCallValid, context, modePacked, count, typePacked, indices);
    }
    else
    {
        GenerateContextLostErrorOnCurrentGlobalContext();
    }
}
</code></pre>
<p>Context.inl.h :</p>
<pre><code class="language-c">ANGLE_INLINE void Context::drawElements(PrimitiveMode mode,
                                        GLsizei count,
                                        DrawElementsType type,
                                        const void *indices)
{
    // No-op if count draws no primitives for given mode
    if (noopDraw(mode, count))
    {
        return;
    }

    ANGLE_CONTEXT_TRY(prepareForDraw(mode)); // GLES1Renderer
    ANGLE_CONTEXT_TRY(mImplementation-&gt;drawElements(this, mode, count, type, indices)); // Go backend: D3d/gl/vulkan
}
</code></pre>
<p>GLES1Renderer::prepareForDraw: </p>
<pre><code class="language-C">Program::setUniform1fv

- Feature enables

- Texture unit enables and format info

- Client state / current vector enables
  - Matrices
  - Alpha test
  - Shading, materials, lighting, fog
  - Clip planes
  - Point rasterization
  - Draw texture
</code></pre>
<p>ContextVk.cpp :</p>
<pre><code class="language-C++">angle::Result ContextVk::drawElements(const gl::Context *context,
                                      gl::PrimitiveMode mode,
                                      GLsizei count,
                                      gl::DrawElementsType type,
                                      const void *indices)
{
    vk::CommandBuffer *commandBuffer = nullptr;
    if (mode == gl::PrimitiveMode::LineLoop)
    {
        uint32_t indexCount;
        ANGLE_TRY(
            setupLineLoopDraw(context, mode, 0, count, type, indices, &amp;commandBuffer, &amp;indexCount));
        vk::LineLoopHelper::Draw(indexCount, 0, commandBuffer);
    }
    else
    {
        ANGLE_TRY(setupIndexedDraw(context, mode, count, 1, type, indices, &amp;commandBuffer));
        commandBuffer-&gt;drawIndexed(count);
    }

    return angle::Result::Continue;
}
</code></pre>
<h1 id="3_1">3. 配置</h1>
<p>OpenGL ES API 可选参数的配置</p>
<h2 id="_9">参数</h2>
<table>
<thead>
<tr>
<th>Capability</th>
<th>ES 2.0 Minimum</th>
<th>ANGLE</th>
<th>SM2</th>
<th>SM3</th>
<th>SM4+</th>
</tr>
</thead>
<tbody>
<tr>
<td>GL_MAX_VERTEX_ATTRIBS</td>
<td>8</td>
<td>16</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GL_MAX_VERTEX_UNIFORM_VECTORS</td>
<td>128</td>
<td>254</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GL_MAX_VERTEX_TEXTURE_IMAGE_UNITS</td>
<td>0</td>
<td>(fn1)</td>
<td>0</td>
<td>0</td>
<td>4</td>
</tr>
<tr>
<td>GL_MAX_VARYING_VECTORS</td>
<td>8</td>
<td>(fn1)</td>
<td>8</td>
<td>10</td>
<td>10</td>
</tr>
<tr>
<td>GL_MAX_FRAGMENT_UNIFORM_VECTORS</td>
<td>16</td>
<td>(fn1)</td>
<td>29</td>
<td>221</td>
<td>221</td>
</tr>
<tr>
<td>GL_MAX_TEXTURE_IMAGE_UNITS</td>
<td>8</td>
<td>16</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GL_MAX_TEXTURE_SIZE</td>
<td>64</td>
<td>2048-16384 (fn1)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GL_MAX_CUBE_MAP_SIZE</td>
<td>16</td>
<td>2048-16384 (fn1)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GL_MAX_RENDERBUFFER_SIZE</td>
<td>1</td>
<td>2048-16384 (fn1)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GL_ALIASED_POINT_SIZE_RANGE (min, max)</td>
<td>(1, 1)</td>
<td>(fn2)</td>
<td>(1,1)</td>
<td>(1, fn2)</td>
<td>(1, fn2)</td>
</tr>
<tr>
<td>GL_ALIASED_LINE_WIDTH_RANGE (min, max)</td>
<td>(1, 1)</td>
<td>(1, 1)</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>fn1：限制因硬件能力而异</li>
<li>fn2：在SM3或更高版本的硬件上，最大点大小为 D3DCAPS9.MaxPointSize</li>
</ul>
<h1 id="_10">总结</h1>
<ul>
<li>优点:</li>
<li>有Google 和 Android 团队的持续更新支持, 并且目标一致: 实现驱动的 GLES on Vulkan</li>
<li>
<p>良好的架构, 精简的面向对象程序设计</p>
</li>
<li>
<p>缺点:</p>
</li>
<li>性能仍需持续改进, 并很可能将来始终有至少 10% 的性能损失</li>
</ul>
<h1 id="_11">其他参考资料</h1>
<p>github 文档 https://github.com/google/angle/tree/master/doc</p>
<p>多平台ANGLE 设计 <em>https://docs.google.com/document/d/17mxRfzXuEWyvGM3t2KqVY4svvfRj_GzysOEpmnDpqeo/edit</em> </p>
<p>ANGLE: OpenGL on Vulkan https://www.youtube.com/watch?v=QrIKdjmpmaA</p>
<p>Vulkan Sessions SIGGRAPH 2019 - (ANGLE 2:59:50)    https://www.youtube.com/watch?v=1fU4w2ZGxH4&amp;list=WL&amp;index=3&amp;t=11119s</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
